# 高效算法/基础知识

## 操作最右边的位元

| 描述 | 公式 |
| -----| ---- |
| 将字组中值为 1 且最靠右的位元置 0 | `x & (x - 1)` |
| 将字组中值为 0 且最靠右的位元置 1 | `x | (x + 1)` |
| 将字组尾部的 1 都置为 0 | `x & (x + 1)` |
| 将字组尾部的 0 都置为 1 | `x | (x - 1)` |
| 将字组中值为 0 且最靠右的位元置 1, 并将其余位置 0 | `!x & (x + 1)` |
| 将字组中值为 1 且最靠右的位元置 0, 并将其余位置 1 | `!x | (x - 1)` |
| 将字组尾部的 0 都置为 1, 并将其余位置 0 | `!x & (x - 1)` |
| 将字组尾部的 1 都置为 0, 并将其余位置 1 | `!x | (x + 1)` |
| 保留字组中值为 1 且最靠右的位元, 并将其余位置 0 | `x & (-x)` |
| 将字组中值为 1 且最靠右的位元及其右方所有值为 0 的位元置 1, 并将左方位元置 0 | `x ^ (x - 1)` |
| 将字组中值为 0 且最靠右的位元及其右方所有值为 1 的位元置 1, 并将左方位元置 0 | `x ^ (x + 1)` |

**例题 1**: 如何判断某个无符号整数是不是 2 的幂或 0?

判断 `x & (x - 1)` 运行结果是否为 0 即可. 在现实中有大量的需要判断给定数是否是 2 的幂的需求, 使用此公式为最优解.

**例题 2**: 如何判断某个无符号整数是不是 2^n - 1 或 0?

判断 `x & (x + 1)` 运行结果是否为 0 即可.

## 德摩根定律

在命题逻辑和逻辑代数中, 德摩根定律是关于命题逻辑规律的一对法则.

- 非 (p 且 q) 等价于 (非 p) 或 (非 q)
- 非 (p 或 q) 等价于 (非 p) 且 (非 q)

德摩根公式在计算机逻辑中的表示和其变形:

```text
!(x & y) = !x | !y
!(x | y) = !x & !y
!-x      = x - 1
!(x ^ y) = !x ^ y
!(x + y) = !x - y
!(x - y) = !x + y
```

## 从右至左的可计算性测试

一个从字组到字组的映射函数, 当且仅当当运算结果中的每一个位元只依赖于各操作数中对应位元及其右侧位元时, 才可以用一系列字并行加减法, 按位与, 按位或及按位取反操作实现出来.

## 绝对值函数

假设 x 为 32 位有符号整数, 首先执行 `y = x >> 31`, 然后套用下列式子之一即可:

|      abs       |      nabs      |
| -------------- | -------------- |
| `(x ^ y) - y`  | `y - (x ^ y)`  |
| `(x + y) ^ y`  | `(y - x) ^ y`  |
| `x - (2x & y)` | `(2x & y) - x` |

上面的这些公式通常用三或四条指令就能实现, 而且不带分支.

## 两数平均值

下列公式可以计算出两个无符号整数的平均值, 而且还不会溢出:

```text
(x & y) + ((x ^ y) >> 1)
```

对于有符号数, 有两种平均值, 一种是出现小数时向下取整, 另一种是向上取整, 分别使用公式

```text
(x & y) + ((x ^ y) >> 1)
(x | y) - ((x ^ y) >> 1)
```

## 符号扩展

这里所说的符号扩展, 指现在字组中确定某个位元为符号位, 然后再把它的值向左传播, 覆盖掉那些位元中原来的值. 通常实现符号扩展的方法是: 先进行逻辑左移, 然后进行带符号的右移. 然而若是没有这些指令, 可以考虑用下列算法之一来计算. 此处列出将 7 号位元向左传播的三种算式.

- `((x + 0x00000080) & 0x000000FF) - 0x00000080`
- `((x & 0x000000FF) ^ 0x00000080) - 0x00000080`
- `(x & 0x0000007F) - (x & 00000080)`

算式中的加法也可以用减法或异或代替. 第二个公式特别有用, 因为加入可以确定符号位左方全都是 0, 那么其中的按位和操作也可以省略了.

## 无符号右移模拟带符号右移

```text
(( x + 0x80000000) >> n) - (0x80000000 >> n)
```

## 三值比较函数

```text
cmp(x, y) = -1, x < y
          =  0, x = y
          =  1, x > y
```

下面的公式对无符号数和带符号数均适用

- `(x > y) - (x < y)`
- `(x >= y) - (x <= y)`

## 循环移位

- 无符号整数循环左移: `(x << n) | (x >> (32 - n))`
- 无符号整数循环右移: `(x >> n) | (x << (32 - n))`

## 互换寄存器中的值

```text
x = x ^ y
y = x ^ y
x = x ^ y
```

## 在两个值之间切换

假设 x 的取值只可能是 a 或 b, 而现在需要将 x 设置为与当前值不同的另一个值. 有下面两种做法(无需理会可能的溢出):

- `x = a + b - x`
- `x = a ^ b ^ x`
